
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>2.4. Data Mapper &#8212; DesignPatternsPHP 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.5. Decorator" href="../Decorator/README.html" />
    <link rel="prev" title="2.3. Composite" href="../Composite/README.html" />
  
   

  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../Decorator/README.html" title="2.5. Decorator"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../Composite/README.html" title="2.3. Composite"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../README.html">DesignPatternsPHP 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../README.html" accesskey="U">2. Structural</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    ../../README.html" class="text-logo">DesignPatternsPHP</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Creational/README.html">1. Creational</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../README.html">2. Structural</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Adapter/README.html">2.1. Adapter / Wrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Bridge/README.html">2.2. Bridge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Composite/README.html">2.3. Composite</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2.4. Data Mapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Decorator/README.html">2.5. Decorator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DependencyInjection/README.html">2.6. Dependency Injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Facade/README.html">2.7. Facade</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FluentInterface/README.html">2.8. Fluent Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Flyweight/README.html">2.9. Flyweight</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Proxy/README.html">2.10. Proxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Registry/README.html">2.11. Registry</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Behavioral/README.html">3. Behavioral</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../More/README.html">4. More</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../README.html">Docs</a></li>
              
                <li><a href="../README.html">2. Structural</a></li>
              
              <li>2.4. Data Mapper</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="data-mapper">
<h1>2.4. <a class="reference external" href="http://en.wikipedia.org/wiki/Data_mapper_pattern">Data Mapper</a><a class="headerlink" href="#data-mapper" title="Permalink to this headline">¶</a></h1>
<div class="section" id="purpose">
<h2>2.4.1. Purpose<a class="headerlink" href="#purpose" title="Permalink to this headline">¶</a></h2>
<p>A Data Mapper, is a Data Access Layer that performs bidirectional
transfer of data between a persistent data store (often a relational
database) and an in memory data representation (the domain layer). The
goal of the pattern is to keep the in memory representation and the
persistent data store independent of each other and the data mapper
itself. The layer is composed of one or more mappers (or Data Access
Objects), performing the data transfer. Mapper implementations vary in
scope. Generic mappers will handle many different domain entity types,
dedicated mappers will handle one or a few.</p>
<p>The key point of this pattern is, unlike Active Record pattern, the data
model follows Single Responsibility Principle.</p>
</div>
<div class="section" id="examples">
<h2>2.4.2. Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>DB Object Relational Mapper (ORM) : Doctrine2 uses DAO named as
“EntityRepository”</li>
</ul>
</div>
<div class="section" id="uml-diagram">
<h2>2.4.3. UML Diagram<a class="headerlink" href="#uml-diagram" title="Permalink to this headline">¶</a></h2>
<img alt="Alt DataMapper UML Diagram" class="align-center" src="../../_images/uml28.png" />
</div>
<div class="section" id="code">
<h2>2.4.4. Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<p>You can also find this code on <a class="reference external" href="https://github.com/domnikl/DesignPatternsPHP/tree/master/Structural/DataMapper">GitHub</a></p>
<p>User.php</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">DesignPatterns\Structural\DataMapper</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$username</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var string</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$email</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">fromState</span><span class="p">(</span><span class="k">array</span> <span class="nv">$state</span><span class="p">)</span><span class="o">:</span> <span class="nx">User</span>
    <span class="p">{</span>
        <span class="c1">// validate state before accessing keys!</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">self</span><span class="p">(</span>
            <span class="nv">$state</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
            <span class="nv">$state</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$username</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$email</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// validate parameters before setting them!</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$username</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @return string</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUsername</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @return string</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getEmail</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>UserMapper.php</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">DesignPatterns\Structural\DataMapper</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserMapper</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var StorageAdapter</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$adapter</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @param StorageAdapter $storage</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nx">StorageAdapter</span> <span class="nv">$storage</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">adapter</span> <span class="o">=</span> <span class="nv">$storage</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * finds a user from storage based on ID and returns a User object located</span>
<span class="sd">     * in memory. Normally this kind of logic will be implemented using the Repository pattern.</span>
<span class="sd">     * However the important part is in mapRowToUser() below, that will create a business object from the</span>
<span class="sd">     * data fetched from storage</span>
<span class="sd">     *</span>
<span class="sd">     * @param int $id</span>
<span class="sd">     *</span>
<span class="sd">     * @return User</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">findById</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">)</span><span class="o">:</span> <span class="nx">User</span>
    <span class="p">{</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">adapter</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">(</span><span class="s2">&quot;User #</span><span class="si">$id</span><span class="s2"> not found&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mapRowToUser</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">mapRowToUser</span><span class="p">(</span><span class="k">array</span> <span class="nv">$row</span><span class="p">)</span><span class="o">:</span> <span class="nx">User</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">User</span><span class="o">::</span><span class="na">fromState</span><span class="p">(</span><span class="nv">$row</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>StorageAdapter.php</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">DesignPatterns\Structural\DataMapper</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">StorageAdapter</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var array</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$data</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span> <span class="o">=</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @param int $id</span>
<span class="sd">     *</span>
<span class="sd">     * @return array|null</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="nv">$id</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="nv">$id</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="test">
<h2>2.4.5. Test<a class="headerlink" href="#test" title="Permalink to this headline">¶</a></h2>
<p>Tests/DataMapperTest.php</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">DesignPatterns\Structural\DataMapper\Tests</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">DesignPatterns\Structural\DataMapper\StorageAdapter</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">DesignPatterns\Structural\DataMapper\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">DesignPatterns\Structural\DataMapper\UserMapper</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">PHPUnit\Framework\TestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DataMapperTest</span> <span class="k">extends</span> <span class="nx">TestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testCanMapUserFromStorage</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StorageAdapter</span><span class="p">([</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;domnikl&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;liebler.dominik@gmail.com&#39;</span><span class="p">]]);</span>
        <span class="nv">$mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserMapper</span><span class="p">(</span><span class="nv">$storage</span><span class="p">);</span>

        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$mapper</span><span class="o">-&gt;</span><span class="na">findById</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertInstanceOf</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @expectedException \InvalidArgumentException</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testWillNotMapInvalidData</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StorageAdapter</span><span class="p">([]);</span>
        <span class="nv">$mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserMapper</span><span class="p">(</span><span class="nv">$storage</span><span class="p">);</span>

        <span class="nv">$mapper</span><span class="o">-&gt;</span><span class="na">findById</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="../Composite/README.html" title="previous chapter (use the left arrow)">2.3. Composite</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="../Decorator/README.html" title="next chapter (use the right arrow)">2.5. Decorator</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../Decorator/README.html" title="2.5. Decorator"
             >next</a> |</li>
        <li class="right" >
          <a href="../Composite/README.html" title="2.3. Composite"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../README.html">DesignPatternsPHP 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../README.html" >2. Structural</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2015, Dominik Liebler and contributors. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>