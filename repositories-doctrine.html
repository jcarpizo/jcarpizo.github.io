


<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta content="PHP 5.4.15+ with PHP Unit testing - Object Oriented Programming in PHP / RESTful API’s ,PHP Code Sniffer for checking coding compliance / PSR-2 standard coding style ,MVC PHP Framework – Symfony , Laravel, CakePHP and Phalcon,Docker Engine / Docker Hub,Guzzle, PHP HTTP Client,Auth0's API authorization,Google API, Twillio API, and Facebook API Integration,Object Relational Mapper (ORM) / Doctrine Query Language,JAVA Programming (J2SE),Angular JS 1 / 2 with Protractor End to End Tesing for Angular- JavaScript’s Framework,Joomla, Wordpress and Drupal ( Content Management System ), Adobe Flex PHP / Adobe ColdFusion, Unix Shell Scripting in Unix / Linux Environment,Twitter Bootstrap / Foundation,Grunt: The JavaScript Task Runner ,Qunit Javascript Unit Testing,Python 2.7.10 ,Highcharts JS ,Node JS, React JS, Vue JS, JQuery, and Navtive Javascript ,eJabberd XMPP Server ,Bitbuket with Pipeline Build Integration ,GitLab with Gitlab CI integration ,Git with Git Flow Integration ,MS SQL Enterprise ,MySQL with MySql Workbench and Sequel Pro, Postgre SQL,Composer for PHP dependencies,WebPack Node JS for JavaScript and Css dependencies ,Solaris 10 / Ubuntu 16.04 / Fedora 18 / Backtrack / Mac OS X – Unix and Linux OS ,Windows XP, Vista, 7 and 8 ,VMware Server / Virtual Box / Homestead ,HTML5, CSS and SASS ,SPHINX - Python Documentation Generator ,Sample API docs for mobile dev - Leaders Summit API Docs." name="description" />
<meta content="PHP 5.4.15+ with PHP Unit testing - Object Oriented Programming in PHP / RESTful API’s ,PHP Code Sniffer for checking coding compliance / PSR-2 standard coding style ,MVC PHP Framework – Symfony , Laravel, CakePHP and Phalcon,Docker Engine / Docker Hub,Guzzle, PHP HTTP Client,Auth0's API authorization,Google API, Twillio API, and Facebook API Integration,Object Relational Mapper (ORM) / Doctrine Query Language,JAVA Programming (J2SE),Angular JS 1 / 2 with Protractor End to End Tesing for Angular- JavaScript’s Framework,Joomla, Wordpress and Drupal ( Content Management System ), Adobe Flex PHP / Adobe ColdFusion, Unix Shell Scripting in Unix / Linux Environment,Twitter Bootstrap / Foundation,Grunt: The JavaScript Task Runner ,Qunit Javascript Unit Testing,Python 2.7.10 ,Highcharts JS ,Node JS, React JS, Vue JS, JQuery, and Navtive Javascript ,eJabberd XMPP Server ,Bitbuket with Pipeline Build Integration ,GitLab with Gitlab CI integration ,Git with Git Flow Integration ,MS SQL Enterprise ,MySQL with MySql Workbench and Sequel Pro, Postgre SQL,Composer for PHP dependencies,WebPack Node JS for JavaScript and Css dependencies ,Solaris 10 / Ubuntu 16.04 / Fedora 18 / Backtrack / Mac OS X – Unix and Linux OS ,Windows XP, Vista, 7 and 8 ,VMware Server / Virtual Box / Homestead ,HTML5, CSS and SASS ,SPHINX - Python Documentation Generator ,Sample API docs for mobile dev - Leaders Summit API Docs." name="keywords" />
<meta content="Jasper Carpizo" name="author" />

  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Using Repositories in Doctrine 2 &#8212; Jasper Carpizo</title>
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/jenkins.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Composite Pattern in PHP" href="composite-pattern.html" />
    <link rel="prev" title="Synchronized GMail Inbox [PHP]" href="sync-gmail-inbox.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="composite-pattern.html" title="Composite Pattern in PHP"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="sync-gmail-inbox.html" title="Synchronized GMail Inbox [PHP]"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Reference Documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    index.html" class="text-logo">Jasper Carpizo</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lamp.html">Install LAMP in one command</a></li>
<li class="toctree-l1"><a class="reference internal" href="lemp.html">How To Install Linux, Nginx, MySQL, PHP (LEMP stack) on Ubuntu 18.04</a></li>
<li class="toctree-l1"><a class="reference internal" href="xampp.html">XAMPP - Replacing MariaDB with MySQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="mac-mysql.html">Install MySQL on Mac OS X</a></li>
<li class="toctree-l1"><a class="reference internal" href="php-install.html">Install PHP 5.6 or PHP 7.1 on Ubuntu 16.04, 14.04 using PPA</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx.html">Install Sphinx Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="install-node.html">Install Node.js via Package Manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="ejabberd.html">Install eJabberd XMPP Server on Ubuntu 14</a></li>
<li class="toctree-l1"><a class="reference internal" href="mac-php.html">Update PHP on Mac OS X</a></li>
<li class="toctree-l1"><a class="reference internal" href="php-codesniffer.html">PHP CodeSniffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="virtual-host.html">Set Up Apache Virtual Hosts on Ubuntu 16.04 LTS</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple-php.html">Switch between Multiple PHP Version on Ubuntu</a></li>
<li class="toctree-l1"><a class="reference internal" href="doctrine.html">Doctrine Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="solid.html">The First 5 Principles of Object Oriented Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="file-permission.html">Unix / Linux File permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">Git Training Videos</a></li>
<li class="toctree-l1"><a class="reference internal" href="git-flow.html">Git Flow Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="adwords-api.html">Adwords API Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="tao-of-programming.html">The Tao / Zen of Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="php-storm.html">PhpStorm Keymap Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="sync-gmail-inbox.html">Synchronized GMail Inbox [PHP]</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using Repositories in Doctrine 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="composite-pattern.html">Composite Pattern in PHP</a></li>
<li class="toctree-l1"><a class="reference internal" href="owasp.html">OWASP Secure Coding Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="mysql.html">Getting the Best MySQL Performance in Your Products</a></li>
<li class="toctree-l1"><a class="reference internal" href="menu-tree.html">Build a Menu with Recursive Functions</a></li>
</ul>

    
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="index.html">Docs</a></li>
              
              <li>Using Repositories in Doctrine 2</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="using-repositories-in-doctrine-2">
<h1>Using Repositories in Doctrine 2<a class="headerlink" href="#using-repositories-in-doctrine-2" title="Permalink to this headline">¶</a></h1>
<p>One feature of Doctrine 2 and other data mapper style ORM’s is that rather than each class model invoking itself to make queries in the database (Active Record style), custom queries to the database are handled by a bridge layer that is extends the Entity Manager.</p>
<p>We cannot do any any queries to the DB without going through the Entity Manager, here is the simplest case:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="s1">&#39;Entities\User&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">);</span>
</pre></div>
</div>
<p>But more often than not we will need to go through a repository for that model, in the Java world these are often referred to as Data Access Objects or DAO’s. Again a simple example would look like the following:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$user</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Entities\User&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
</pre></div>
</div>
<p>Here the Entity Manager will look for the Repository which is attached to your Entity class. If you have not set this yet it will provide you with a default Repository class (DoctrineORMEntityRepository) which contains the following methods for accessing your data:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">findAll</span><span class="p">()</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findBy</span><span class="p">(</span><span class="k">array</span> <span class="nv">$criteria</span><span class="p">)</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">findOneBy</span><span class="p">(</span><span class="k">array</span> <span class="nv">$criteria</span><span class="p">)</span>
</pre></div>
</div>
<p>With these very simple methods you can get direct access to your data, but more than often this will not be enough. The default EntitiyRepository class contains</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">createQueryBuilder</span><span class="p">(</span><span class="nv">$alias</span><span class="p">)</span>
</pre></div>
</div>
<p>Which you can probably just go ahead and use just like in the example above (I have never tried) in your controller etc, but this should not really be done, when you need the power of the query builder, DQL (Doctrine Query Language) or native SQL calls you should be writing these in your own repository class for the particular entity that you are using.</p>
<p>This will inherit DoctrineORMEntityRepository:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nx">Repositories</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Entities</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">UserRepository</span> <span class="k">extends</span> <span class="nx">EntityRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">finderMethod</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// My custom query etc</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>But you need to tell Doctrine now that you have created this repository. You can do that by the Driver Implementation type you are using(ie YAML/Annotations/XML). I use annotations and I highly recommend you do as it keeps everything in the same place. Here is how we do this in your entitiy class:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="nx">Entities</span><span class="p">;</span>

<span class="sd">/** @Entity(repositoryClass=&quot;Repositories\UserRepository&quot;)</span>
<span class="sd"> *  @Table(name=&quot;dealers&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">User</span>
</pre></div>
</div>
<p>So now when you try and access your own custom finder method it will now all be lovely-jubbly!:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="nv">$users</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">&#39;Entities\User&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">finderMethod</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">);</span>
</pre></div>
</div>
<p>Which you can add the following type of repository custome finder method:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">function</span> <span class="nf">findAuthenticatedUsersForDate</span><span class="p">(</span><span class="nv">$date</span><span class="p">)</span>
<span class="p">{</span>

    <span class="c1">// First get the EM handle</span>
    <span class="c1">// and call the query builder on it</span>
    <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_em</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">();</span>
    <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">select</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">from</span><span class="p">(</span><span class="s1">&#39;Entities\User&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;u.authenticated = 1&#39;</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">andWhere</span><span class="p">(</span><span class="s1">&#39;u.date = :date&#39;</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="nv">$date</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;u.name&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>I found the $qb-&gt;getQuery()-&gt;getResult(); explanations quite scarce, but you need to use them even if using DQL.</p>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="sync-gmail-inbox.html" title="previous chapter (use the left arrow)">Synchronized GMail Inbox [PHP]</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="composite-pattern.html" title="next chapter (use the right arrow)">Composite Pattern in PHP</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="composite-pattern.html" title="Composite Pattern in PHP"
             >next</a> |</li>
        <li class="right" >
          <a href="sync-gmail-inbox.html" title="Synchronized GMail Inbox [PHP]"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Reference Documentation</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2009-2018 Jasper Carpizo. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-133821205-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>